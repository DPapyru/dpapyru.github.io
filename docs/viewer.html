<!DOCTYPE html>
<!-- 泰拉瑞亚Mod制作教程文档查看器页面 -->
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档查看器 - 泰拉瑞亚Mod制作教程</title>
    <!-- 加载CSS样式文件 -->
    <link rel="stylesheet" href="../assets/css/style.css"> <!-- 主样式文件 -->
    <link rel="stylesheet" href="../assets/css/prism.min.css"> <!-- 代码高亮样式 -->
    <link rel="stylesheet" href="../assets/css/vs2022-theme.css"> <!-- VS2022代码高亮主题 -->
    <link rel="icon" type="image/png" href="../assets/imgs/Green_tModLoader.png"> <!-- 网站图标 -->
</head>

<body>
    <!-- 网站头部导航区域 -->
    <header class="site-header">
        <div class="container">
            <!-- 头部内容容器：包含网站logo、导航菜单和移动端菜单按钮 -->
            <div class="header-content">
                <!-- 网站logo和标题 -->
                <div class="logo">
                    <a href="../index.html">
                        <img src="../assets/imgs/Green_tModLoader.png" alt="泰拉瑞亚Mod制作教程" class="logo-image">
                        <h1 class="site-title">泰拉瑞亚Mod制作教程</h1>
                    </a>
                </div>
                <!-- 主导航菜单 -->
                <nav class="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item"><a href="../index.html" class="nav-link">首页</a></li>
                        <li class="nav-item"><a href="../docs/" class="nav-link active">文档</a></li>
                        <li class="nav-item"><a href="https://github.com/DPapyru/DPapyru.github.io" class="nav-link"
                                target="_blank">GitHub</a></li>
                    </ul>
                </nav>
                <!-- 移动端菜单切换按钮 -->
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- 网站主体容器：包含侧边栏和主内容区 -->
    <div class="site-container">
        <!-- 左侧边栏：文档导航和相关链接 -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <!-- 侧边栏第一部分：文档导航 -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">文档导航</h3>
                    <ul class="sidebar-list" id="category-sidebar">
                        <!-- 分类侧边栏将通过JavaScript动态生成 -->
                    </ul>
                </div>
                <!-- 侧边栏第二部分：当前分类文档 -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title" id="current-category-title">当前分类</h3>
                    <ul class="sidebar-list" id="current-category-docs">
                        <!-- 当前分类的文档列表将通过JavaScript动态生成 -->
                    </ul>
                </div>
                <!-- 侧边栏第三部分：贡献者信息 -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">贡献者</h3>
                    <div class="contributors">
                        <p>欢迎参与贡献！</p>
                        <a href="../CONTRIBUTING.md" class="btn btn-small">如何贡献</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区域：显示Markdown文档内容 -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- 教程头部区域：包含面包屑导航和文档元信息 -->
                <div class="tutorial-header">
                    <!-- 面包屑导航 -->
                    <div class="breadcrumb">
                        <a href="../index.html">首页</a> &gt;
                        <a href="../docs/">文档</a> &gt;
                        <span class="current" id="current-doc-name">文档</span>
                    </div>
                    <!-- 文档标题 -->
                    <h1 class="tutorial-title" id="doc-title">文档</h1>
                    <!-- 文档元信息：难度、时间、作者、更新日期 -->
                    <div class="tutorial-meta" id="doc-meta">
                        <span class="difficulty">难度: <span class="difficulty-badge" id="doc-difficulty">未知</span></span>
                        <span class="time">预计时间: <span id="doc-time">未知</span></span>
                        <span class="author">作者: <span id="doc-author">未知</span></span>
                        <span class="date">更新日期: <span id="doc-date">未知</span></span>
                    </div>
                </div>

                <!-- 教程内容区域：加载和显示Markdown内容 -->
                <div class="tutorial-content">
                    <!-- 加载状态指示器：显示内容加载中的提示 -->
                    <div id="loading-indicator" class="loading-indicator">
                        <div class="loading-spinner"></div>
                        <p>正在加载内容...</p>
                    </div>

                    <!-- 错误信息容器：当内容加载失败时显示错误信息 -->
                    <div id="error-message" class="error-message" style="display: none;">
                        <h3>加载失败</h3>
                        <p id="error-text">无法加载文档内容，请稍后再试。</p>
                    </div>

                    <!-- 目录容器：自动生成的文档目录 -->
                    <div id="table-of-contents" class="table-of-contents" style="display: none;">
                        <h3>目录</h3>
                        <ul id="toc-list"></ul>
                    </div>

                    <!-- Markdown内容容器：渲染后的HTML内容将插入这里 -->
                    <div id="markdown-content" class="markdown-content" style="display: none;">
                        <!-- 文档内容将通过Markdown渲染后插入这里 -->
                    </div>
                </div>

                <!-- 教程底部区域：导航链接和反馈表单 -->
                <div class="tutorial-footer">
                    <!-- 教程导航：上一篇/下一篇链接 -->
                    <div class="tutorial-navigation">
                        <a href="../docs/" class="btn btn-outline prev-tutorial">← 返回文档列表</a>
                        <a href="?file=test.md" class="btn btn-secondary">测试文档</a>
                        <a href="?file=02-基础概念/basic-concepts.md" class="btn btn-primary next-tutorial">基础教程 →</a>
                    </div>
                    <!-- 教程反馈：用户反馈和问题提交 -->
                    <div class="tutorial-feedback">
                        <h3>教程反馈</h3>
                        <p>如果你对本教程有任何问题或建议，欢迎在GitHub上提出Issue或PR。</p>
                        <a href="https://github.com/DPapyru/DPapyru.github.io/issues" class="btn btn-small"
                            target="_blank">提供反馈</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 网站底部区域 -->
    <footer class="site-footer">
        <div class="container">
            <!-- 底部内容容器 -->
            <div class="footer-content">
                <!-- 底部第一栏：关于项目 -->
                <div class="footer-section">
                    <h4>关于项目</h4>
                    <p>这是一个面向泰拉瑞亚Mod开发者的协作教程项目，旨在降低Mod制作门槛。</p>
                </div>
                <!-- 底部第二栏：快速链接 -->
                <div class="footer-section">
                    <h4>快速链接</h4>
                    <ul>
                        <li><a href="../index.html">首页</a></li>
                        <li><a href="../docs/">文档</a></li>
                        <li><a href="https://github.com/DPapyru/DPapyru.github.io" target="_blank">GitHub</a></li>
                    </ul>
                </div>
                <!-- 底部第三栏：联系我们 -->
                <div class="footer-section">
                    <h4>联系我们</h4>
                    <ul>
                        <li><a href="https://github.com/DPapyru/DPapyru.github.io" target="_blank">GitHub</a></li>
                        <li><a href="mailto:contact@example.com">邮箱</a></li>
                    </ul>
                </div>
            </div>
            <!-- 底部版权信息 -->
            <div class="footer-bottom">
                <p>&copy; 2023 泰拉瑞亚Mod制作教程. 采用 <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC
                        BY 4.0</a> 许可协议。</p>
            </div>
        </div>
    </footer>

    <!-- 加载JavaScript文件 -->
    <script src="../assets/js/marked.min.js"></script> <!-- Markdown解析库 -->
    <script src="../assets/js/prism.min.js"></script> <!-- 代码高亮库 -->
    <script src="../assets/js/prism-csharp.min.js"></script> <!-- C#语言高亮支持 -->
    <script>
        // 设置一个标志，告诉main.js这是viewer.html页面，不要执行自动加载
        window.IS_VIEWER_PAGE = true;

        // 禁用main.js中的路由系统，避免干扰viewer.html的文件加载
        window.DISABLE_ROUTER = true;
    </script>
    <script src="../assets/js/main.js"></script> <!-- 主要功能脚本 -->
    <script src="../assets/js/navigation.js"></script> <!-- 导航功能脚本 -->

    <script>
        // 文档配置和元数据管理
        let DOC_CONFIG = null;
        let ALL_DOCS = [];
        
        // 主分类配置
        const MAIN_CATEGORIES = {
            '入门': {
                title: '入门',
                description: '适合初学者的基础教程',
                order: 1
            },
            '进阶': {
                title: '进阶',
                description: '有一定基础后的进阶教程',
                order: 2
            },
            '高级': {
                title: '高级',
                description: '面向有经验开发者的高级教程',
                order: 3
            },
            '个人分享': {
                title: '个人分享',
                description: '社区成员的个人经验和技巧分享',
                order: 4
            }
        };
        
        // 主题领域配置
        const TOPIC_AREAS = {
            'env': {
                title: '环境配置',
                description: '开发环境搭建和配置'
            },
            'mod-basics': {
                title: 'Mod基础',
                description: 'Mod开发的基础概念和核心API'
            },
            'items': {
                title: '物品系统',
                description: '物品、武器和装备的开发'
            },
            'npcs': {
                title: 'NPC系统',
                description: 'NPC的创建和行为定制'
            },
            'world-gen': {
                title: '世界生成',
                description: '世界生成和地形修改'
            },
            'ui': {
                title: 'UI界面',
                description: '用户界面和交互设计'
            },
            'networking': {
                title: '网络功能',
                description: '多人游戏和网络通信'
            },
            'advanced': {
                title: '高级功能',
                description: '高级开发技巧和优化'
            }
        };

        // 旧路径重定向映射
        const OLD_PATH_REDIRECTS = {
            '01-入门指南/README.md': 'test.md',
            '02-基础概念/basic-concepts.md': 'test.md',
            '03-内容创建/content-creation.md': 'test.md',
            '04-高级开发/advanced-development.md': 'test.md',
            '05-专题主题/special-topics.md': 'test.md',
            '06-资源参考/resource-reference.md': 'test.md'
        };

        // 文档查看器的主要JavaScript逻辑
        document.addEventListener('DOMContentLoaded', function () {
            console.log('=== docs/viewer.html: 页面加载完成 ===');
            console.log('=== 诊断信息 ===');
            console.log('当前页面URL:', window.location.href);
            console.log('当前页面路径:', window.location.pathname);
            console.log('当前搜索参数:', window.location.search);

            // 初始化文档配置
            initializeDocumentConfig().then(() => {
                // 初始化分类导航
                initializeCategoryNavigation();

                // 从URL参数获取要加载的Markdown文件
                const urlParams = new URLSearchParams(window.location.search);
                let markdownFile = urlParams.get('file');
                console.log('从URL参数获取的文件名:', markdownFile);

                // 如果没有指定文件，尝试从路径中获取
                if (!markdownFile) {
                    const pathParts = window.location.pathname.split('/');
                    markdownFile = pathParts[pathParts.length - 1];
                    console.log('从路径获取的文件名:', markdownFile);
                }

                // 如果还是没有，默认加载test.md
                if (!markdownFile || !markdownFile.endsWith('.md')) {
                    markdownFile = 'test.md';
                    console.log('使用默认文件名:', markdownFile);
                }

                console.log(`docs/viewer.html: 准备加载Markdown文件: ${markdownFile}`);

                // 延迟加载，确保所有脚本都已初始化
                setTimeout(function () {
                    // 直接使用本地加载函数，避免main.js中的路径处理问题
                    console.log('docs/viewer.html: 使用本地loadMarkdownDirectly函数');
                    loadMarkdownDirectly(markdownFile);
                }, 200);
            });

            // 初始化下拉菜单
            initializeDropdownMenu();
        });

        // 初始化文档配置
        async function initializeDocumentConfig() {
            try {
                // 尝试加载配置文件
                const configResponse = await fetch('./config.json');
                if (configResponse.ok) {
                    DOC_CONFIG = await configResponse.json();
                    console.log('成功加载配置文件:', DOC_CONFIG);
                } else {
                    console.warn('配置文件不存在，使用默认配置');
                    DOC_CONFIG = generateDefaultConfig();
                }
            } catch (error) {
                console.warn('加载配置文件失败，使用默认配置:', error);
                DOC_CONFIG = generateDefaultConfig();
            }
            
            // 扫描所有文档文件
            await scanAllDocuments();
        }

        // 生成默认配置（当config.json不存在时）
        function generateDefaultConfig() {
            const config = {
                categories: {},
                topics: {},
                authors: {},
                all_files: []
            };

            // 初始化分类结构
            Object.keys(MAIN_CATEGORIES).forEach(categoryKey => {
                config.categories[categoryKey] = {
                    title: MAIN_CATEGORIES[categoryKey].title,
                    description: MAIN_CATEGORIES[categoryKey].description,
                    topics: {}
                };
            });

            // 初始化主题结构
            Object.keys(TOPIC_AREAS).forEach(topicKey => {
                config.topics[topicKey] = {
                    title: TOPIC_AREAS[topicKey].title,
                    description: TOPIC_AREAS[topicKey].description
                };
            });

            return config;
        }

        // 扫描所有文档文件
        async function scanAllDocuments() {
            console.log('=== scanAllDocuments() 诊断开始 ===');
            try {
                // 由于Python http.server会自动返回index.html而不是目录列表，
                // 我们直接使用配置文件中的文档列表，而不是扫描目录
                console.log('使用配置文件中的文档列表，而不是扫描目录');
                
                // 首先尝试加载配置文件
                try {
                    const configResponse = await fetch('./config.json');
                    if (configResponse.ok) {
                        const config = await configResponse.json();
                        console.log('成功加载配置文件:', config);
                        
                        // 从配置文件中提取文档列表
                        ALL_DOCS = config.all_files || [];
                        console.log('从配置文件加载的文档:', ALL_DOCS);
                        
                        // 如果配置文件中有文档，直接使用
                        if (ALL_DOCS.length > 0) {
                            console.log('=== scanAllDocuments() 诊断结束 ===');
                            return;
                        }
                    }
                } catch (configError) {
                    console.warn('加载配置文件失败:', configError);
                }
                
                // 如果配置文件加载失败或没有文档，尝试已知的文档列表
                const knownFiles = ['test.md'];
                console.log('尝试已知的文档列表:', knownFiles);
                
                ALL_DOCS = [];
                
                for (const filename of knownFiles) {
                    try {
                        // 获取文档内容和元数据
                        const docUrl = `./${filename}`;
                        console.log('尝试获取文档内容，URL:', docUrl);
                        const docResponse = await fetch(docUrl);
                        console.log(`获取文档 ${filename} 响应状态:`, docResponse.status, docResponse.statusText);
                        
                        if (docResponse.ok) {
                            const content = await docResponse.text();
                            const { metadata } = parseFrontMatter(content);
                            
                            const docInfo = {
                                filename: filename,
                                title: metadata.title || filename.replace('.md', ''),
                                author: metadata.author || '未知',
                                category: metadata.category || '入门',
                                topic: metadata.topic || 'mod-basics',
                                order: parseInt(metadata.order) || 999,
                                description: metadata.description || '',
                                tags: metadata.tags ? metadata.tags.split(',').map(t => t.trim()) : [],
                                last_updated: metadata.last_updated || '未知'
                            };
                            
                            ALL_DOCS.push(docInfo);
                            console.log('成功添加文档:', docInfo.title);
                            
                            // 更新配置
                            updateConfigWithDocument(docInfo);
                        }
                    } catch (error) {
                        console.warn(`无法处理文档 ${filename}:`, error);
                    }
                }
                
                // 按分类和排序
                ALL_DOCS.sort((a, b) => {
                    if (a.category !== b.category) {
                        return MAIN_CATEGORIES[a.category].order - MAIN_CATEGORIES[b.category].order;
                    }
                    return a.order - b.order;
                });
                
                console.log('扫描到的文档:', ALL_DOCS);
                console.log('=== scanAllDocuments() 诊断结束 ===');
                
            } catch (error) {
                console.error('扫描文档失败:', error);
                console.log('=== scanAllDocuments() 因错误结束 ===');
                // 提供一些默认文档
                ALL_DOCS = [
                    {
                        filename: 'test.md',
                        title: '测试文档',
                        author: '测试',
                        category: '入门',
                        topic: 'mod-basics',
                        order: 1,
                        description: '用于测试文档查看器功能的示例文档',
                        tags: ['测试'],
                        last_updated: '2025-11-26'
                    }
                ];
            }
        }

        // 使用文档信息更新配置
        function updateConfigWithDocument(docInfo) {
            const { category, topic } = docInfo;
            
            // 确保分类存在
            if (!DOC_CONFIG.categories[category]) {
                DOC_CONFIG.categories[category] = {
                    title: category,
                    description: `${category}相关文档`,
                    topics: {}
                };
            }
            
            // 确保主题存在
            if (!DOC_CONFIG.categories[category].topics[topic]) {
                DOC_CONFIG.categories[category].topics[topic] = {
                    title: TOPIC_AREAS[topic]?.title || topic,
                    description: TOPIC_AREAS[topic]?.description || '',
                    files: []
                };
            }
            
            // 添加文件到对应主题
            DOC_CONFIG.categories[category].topics[topic].files.push(docInfo);
            
            // 更新作者信息
            if (!DOC_CONFIG.authors[docInfo.author]) {
                DOC_CONFIG.authors[docInfo.author] = {
                    name: docInfo.author,
                    files: []
                };
            }
            DOC_CONFIG.authors[docInfo.author].files.push(docInfo.filename);
            
            // 添加到所有文件列表
            DOC_CONFIG.all_files.push(docInfo);
        }

        // 直接加载Markdown内容的备用函数
        function loadMarkdownDirectly(filePath) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const markdownContent = document.getElementById('markdown-content');

            console.log(`=== loadMarkdownDirectly() 诊断开始 ===`);
            console.log(`docs/viewer.html: 原始文件路径: ${filePath}`);
            console.log('当前页面位置:', window.location.href);

            // 增强的路径清理逻辑
            let fetchPath = filePath;
            console.log(`docs/viewer.html: 初始fetchPath: ${fetchPath}`);

            // 1. URL解码
            fetchPath = decodeURIComponent(fetchPath);
            console.log(`docs/viewer.html: URL解码后: ${fetchPath}`);

            // 2. 移除开头的docs/前缀（因为viewer.html已经在docs目录中）
            if (fetchPath.startsWith('docs/')) {
                fetchPath = fetchPath.substring(5);
                console.log(`docs/viewer.html: 移除docs前缀: ${fetchPath}`);
            }

            // 3. 移除开头的斜杠
            if (fetchPath.startsWith('/')) {
                fetchPath = fetchPath.substring(1);
                console.log(`docs/viewer.html: 移除开头斜杠: ${fetchPath}`);
            }

            // 4. 检查是否是旧路径格式，进行重定向
            if (OLD_PATH_REDIRECTS[fetchPath]) {
                fetchPath = OLD_PATH_REDIRECTS[fetchPath];
                console.log(`docs/viewer.html: 旧路径重定向: ${fetchPath}`);
            }

            // 5. 检查是否是已知的分类名或特殊文件
            const knownCategories = ['00-测试文档', '01-入门指南', '02-基础概念', '03-内容创建', '04-高级开发', '05-专题主题', '06-资源参考'];
            const rootFiles = ['test.md']; // 位于docs根目录的文件列表
            
            if (knownCategories.includes(fetchPath) || fetchPath.match(/^\d+-[^\/]+$/)) {
                // 如果是分类名，尝试重定向到对应的文档
                console.log(`docs/viewer.html: 识别为旧分类名，尝试重定向`);
                // 尝试找到该分类下的第一个文档
                const firstDoc = ALL_DOCS.find(doc => doc.category === getCategoryFromOldPath(fetchPath));
                if (firstDoc) {
                    fetchPath = firstDoc.filename;
                    console.log(`docs/viewer.html: 重定向到文档: ${fetchPath}`);
                } else {
                    // 如果找不到对应文档，使用默认文档
                    fetchPath = 'test.md';
                    console.log(`docs/viewer.html: 未找到对应文档，使用默认: ${fetchPath}`);
                }
            } else if (rootFiles.includes(fetchPath)) {
                // 如果是根目录下的特殊文件，直接使用
                console.log(`docs/viewer.html: 识别为根目录文件: ${fetchPath}`);
            } else if (fetchPath.includes('/')) {
                // 路径已经包含目录，检查是否是旧格式
                if (fetchPath.match(/^\d+-[^\/]+\/.*/)) {
                    // 旧格式路径，尝试重定向
                    console.log(`docs/viewer.html: 识别为旧格式路径，尝试重定向`);
                    const filename = fetchPath.split('/').pop();
                    const doc = ALL_DOCS.find(d => d.filename === filename || d.filename.endsWith(filename));
                    if (doc) {
                        fetchPath = doc.filename;
                        console.log(`docs/viewer.html: 重定向到文档: ${fetchPath}`);
                    } else {
                        // 如果找不到对应文档，使用默认文档
                        fetchPath = 'test.md';
                        console.log(`docs/viewer.html: 未找到对应文档，使用默认: ${fetchPath}`);
                    }
                } else {
                    // 路径已经包含目录，直接使用
                    console.log(`docs/viewer.html: 使用完整路径: ${fetchPath}`);
                }
            } else {
                // 如果只是文件名，检查是否存在于文档列表中
                const doc = ALL_DOCS.find(d => d.filename === fetchPath || d.filename === `${fetchPath}.md`);
                if (doc) {
                    fetchPath = doc.filename;
                    console.log(`docs/viewer.html: 找到匹配文档: ${fetchPath}`);
                } else {
                    // 如果找不到，使用默认文档
                    fetchPath = 'test.md';
                    console.log(`docs/viewer.html: 未找到匹配文档，使用默认: ${fetchPath}`);
                }
            }

            // 6. 确保文件以.md结尾
            if (!fetchPath.endsWith('.md')) {
                fetchPath += '.md';
                console.log(`docs/viewer.html: 添加.md扩展名: ${fetchPath}`);
            }

            console.log(`docs/viewer.html: 最终使用路径: ${fetchPath}`);

            // 确保路径相对于当前页面（docs目录）
            const fetchUrl = fetchPath.startsWith('./') ? fetchPath : `./${fetchPath}`;
            console.log(`docs/viewer.html: 实际fetch URL: ${fetchUrl}`);
            console.log(`完整请求URL将是: ${window.location.origin}${window.location.pathname.replace(/\/[^\/]*$/, '/')}${fetchUrl}`);

            fetch(fetchUrl)
                .then(response => {
                    console.log(`获取响应状态: ${response.status} ${response.statusText}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(markdownText => {
                    console.log(`docs/viewer.html: 成功获取Markdown内容，长度: ${markdownText.length}`);

                    if (typeof marked !== 'undefined') {
                        console.log('marked.js已加载，开始渲染');

                        // 解析Front Matter（文档元数据）
                        const frontMatter = parseFrontMatter(markdownText);
                        const content = frontMatter.content;
                        const metadata = frontMatter.metadata;

                        console.log('解析的元数据:', metadata);

                        // 更新页面元数据（标题、难度、作者等）
                        updatePageMetadata(metadata, fetchPath);

                        // 更新当前分类的文档列表
                        updateCurrentCategoryDocs(fetchPath);

                        // 渲染Markdown内容为HTML
                        const renderedHTML = marked.parse(content);
                        console.log('Markdown渲染完成，HTML长度:', renderedHTML.length);
                        markdownContent.innerHTML = renderedHTML;

                        // 应用代码语法高亮
                        if (typeof Prism !== 'undefined') {
                            console.log('应用代码高亮');
                            Prism.highlightAllUnder(markdownContent);
                        } else {
                            console.warn('Prism.js未加载，跳过代码高亮');
                        }

                        // 自动生成文档目录
                        generateTableOfContents(markdownContent);

                        // 显示内容，隐藏加载指示器
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        markdownContent.style.display = 'block';
                        document.getElementById('table-of-contents').style.display = 'block';

                    } else {
                        throw new Error('marked.js未加载');
                    }
                })
                .catch(error => {
                    console.error('docs/viewer.html: 加载Markdown失败:', error);
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    if (errorMessage) {
                        errorMessage.style.display = 'block';
                        document.getElementById('error-text').textContent = `无法加载文件 "${fetchPath}": ${error.message}`;
                    }
                });
        }

        // 从旧路径获取对应的分类
        function getCategoryFromOldPath(oldPath) {
            const pathMap = {
                '00-测试文档': '入门',
                '01-入门指南': '入门',
                '02-基础概念': '入门',
                '03-内容创建': '进阶',
                '04-高级开发': '高级',
                '05-专题主题': '高级',
                '06-资源参考': '个人分享'
            };
            return pathMap[oldPath] || '入门';
        }

        // 解析Front Matter（文档开头的元数据部分）
        function parseFrontMatter(text) {
            const frontMatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
            const match = text.match(frontMatterRegex);

            if (match) {
                const metadata = {};
                const metadataLines = match[1].split('\n');

                metadataLines.forEach(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const key = line.substring(0, colonIndex).trim();
                        const value = line.substring(colonIndex + 1).trim();
                        metadata[key] = value;
                    }
                });

                return {
                    metadata: metadata,
                    content: match[2]
                };
            }

            return {
                metadata: {},
                content: text
            };
        }

        // 更新页面元数据（标题、难度、时间、作者、日期）
        function updatePageMetadata(metadata, filePath) {
            const title = metadata.title || filePath.replace('.md', '');
            const difficulty = metadata.difficulty || 'beginner';
            const time = metadata.time || '未知';
            const author = metadata.author || '未知';
            const date = metadata.date || '未知';
            const prevChapter = metadata.prev_chapter || null;
            const nextChapter = metadata.next_chapter || null;

            console.log('更新页面元数据:', { title, difficulty, time, author, date, prevChapter, nextChapter });

            document.title = `${title} - 泰拉瑞亚Mod制作教程`;
            document.getElementById('current-doc-name').textContent = title;
            document.getElementById('doc-title').textContent = title;
            document.getElementById('doc-difficulty').textContent = getDifficultyText(difficulty);
            document.getElementById('doc-difficulty').className = `difficulty-badge ${difficulty}`;
            document.getElementById('doc-time').textContent = time;
            document.getElementById('doc-author').textContent = author;
            document.getElementById('doc-date').textContent = date;
            
            // 更新导航按钮
            updateNavigationButtons(prevChapter, nextChapter);
        }

        // 更新导航按钮
        function updateNavigationButtons(prevChapter, nextChapter) {
            const navigationContainer = document.querySelector('.tutorial-navigation');
            if (!navigationContainer) {
                console.warn('找不到导航容器');
                return;
            }

            // 清空现有导航内容
            navigationContainer.innerHTML = '';

            // 添加返回文档列表按钮
            const backToListBtn = document.createElement('a');
            backToListBtn.href = '../docs/';
            backToListBtn.className = 'btn btn-outline prev-tutorial';
            backToListBtn.textContent = '← 返回文档列表';
            navigationContainer.appendChild(backToListBtn);

            // 添加上一章按钮（如果存在）
            if (prevChapter) {
                const prevBtn = document.createElement('a');
                prevBtn.href = `?file=${prevChapter}`;
                prevBtn.className = 'btn btn-secondary prev-tutorial';
                prevBtn.textContent = '← 上一章';
                navigationContainer.appendChild(prevBtn);
            }

            // 添加下一章按钮（如果存在）
            if (nextChapter) {
                const nextBtn = document.createElement('a');
                nextBtn.href = `?file=${nextChapter}`;
                nextBtn.className = 'btn btn-primary next-tutorial';
                nextBtn.textContent = '下一章 →';
                navigationContainer.appendChild(nextBtn);
            }

            console.log('导航按钮已更新:', { prevChapter, nextChapter });
        }

        // 将难度代码转换为中文文本
        function getDifficultyText(difficulty) {
            const difficultyMap = {
                'beginner': '初级',
                'intermediate': '中级',
                'advanced': '高级'
            };
            return difficultyMap[difficulty] || difficulty;
        }

        // 生成文档目录（基于标题h1-h6）
        function generateTableOfContents(contentElement) {
            const tableOfContents = document.getElementById('table-of-contents');
            const tocList = document.getElementById('toc-list');

            if (!tableOfContents || !tocList || !contentElement) {
                return;
            }

            const headings = contentElement.querySelectorAll('h1, h2, h3, h4, h5, h6');
            console.log(`找到 ${headings.length} 个标题用于生成目录`);

            if (headings.length === 0) {
                tableOfContents.style.display = 'none';
                return;
            }

            tocList.innerHTML = '';

            headings.forEach((heading, index) => {
                // 为没有ID的标题自动生成ID
                if (!heading.id) {
                    heading.id = `heading-${index}`;
                }

                // 创建目录项
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${heading.id}`;
                a.textContent = heading.textContent;

                // 根据标题级别设置缩进
                const level = parseInt(heading.tagName.substring(1));
                a.style.paddingLeft = `${(level - 1) * 15}px`;

                li.appendChild(a);
                tocList.appendChild(li);

                // 添加平滑滚动效果
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetElement = document.getElementById(heading.id);
                    if (targetElement) {
                        // 计算滚动位置，考虑固定头部高度
                        const headerHeight = document.querySelector('.site-header').offsetHeight;
                        const targetPosition = targetElement.offsetTop - headerHeight - 20;

                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });

            tableOfContents.style.display = 'block';
            console.log('目录生成完成');
        }

        // 初始化分类导航
        function initializeCategoryNavigation() {
            const categorySidebar = document.getElementById('category-sidebar');

            if (!categorySidebar) return;

            // 清空现有导航
            categorySidebar.innerHTML = '';

            // 等待配置加载完成
            if (!DOC_CONFIG) {
                console.warn('文档配置尚未加载，稍后重试');
                setTimeout(initializeCategoryNavigation, 100);
                return;
            }

            // 生成分类导航
            Object.keys(MAIN_CATEGORIES).forEach(categoryKey => {
                const category = MAIN_CATEGORIES[categoryKey];
                
                // 创建分类导航项
                const categoryItem = document.createElement('li');
                categoryItem.className = 'category-item';
                
                // 创建分类标题
                const categoryHeader = document.createElement('h4');
                categoryHeader.className = 'category-header';
                categoryHeader.textContent = category.title;
                categoryItem.appendChild(categoryHeader);
                
                // 创建主题子菜单
                const topicList = document.createElement('ul');
                topicList.className = 'topic-list';
                
                // 获取该分类下的所有主题
                const categoryTopics = DOC_CONFIG.categories[categoryKey]?.topics || {};
                
                if (Object.keys(categoryTopics).length > 0) {
                    Object.keys(categoryTopics).forEach(topicKey => {
                        const topic = categoryTopics[topicKey];
                        
                        // 创建主题标题
                        const topicHeader = document.createElement('h5');
                        topicHeader.className = 'topic-header';
                        topicHeader.textContent = topic.title;
                        topicList.appendChild(topicHeader);
                        
                        // 创建文档列表
                        const fileList = document.createElement('ul');
                        fileList.className = 'file-list';
                        
                        topic.files.forEach(file => {
                            const fileItem = document.createElement('li');
                            fileItem.className = 'file-item';
                            
                            const fileLink = document.createElement('a');
                            fileLink.href = `?file=${file.filename}`;
                            fileLink.textContent = file.title;
                            fileLink.title = file.description || file.title;
                            
                            fileItem.appendChild(fileLink);
                            fileList.appendChild(fileItem);
                        });
                        
                        topicList.appendChild(fileList);
                    });
                } else {
                    // 如果没有主题，显示提示信息
                    const noDocsItem = document.createElement('li');
                    noDocsItem.className = 'no-docs';
                    noDocsItem.textContent = '暂无文档';
                    topicList.appendChild(noDocsItem);
                }
                
                categoryItem.appendChild(topicList);
                categorySidebar.appendChild(categoryItem);
            });
            
            // 添加"所有文档"部分
            const allDocsItem = document.createElement('li');
            allDocsItem.className = 'category-item all-docs';
            
            const allDocsHeader = document.createElement('h4');
            allDocsHeader.className = 'category-header';
            allDocsHeader.textContent = '所有文档';
            allDocsItem.appendChild(allDocsHeader);
            
            const allDocsList = document.createElement('ul');
            allDocsList.className = 'file-list';
            
            ALL_DOCS.forEach(doc => {
                const docItem = document.createElement('li');
                docItem.className = 'file-item';
                
                const docLink = document.createElement('a');
                docLink.href = `?file=${doc.filename}`;
                docLink.textContent = doc.title;
                docLink.title = `${doc.author} - ${doc.description || doc.title}`;
                
                docItem.appendChild(docLink);
                allDocsList.appendChild(docItem);
            });
            
            allDocsItem.appendChild(allDocsList);
            categorySidebar.appendChild(allDocsItem);
        }

        // 初始化下拉菜单
        function initializeDropdownMenu() {
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdownMenu = document.querySelector('.dropdown-menu');

            if (!dropdownToggle || !dropdownMenu) return;

            // 点击切换下拉菜单
            dropdownToggle.addEventListener('click', function (e) {
                e.preventDefault();
                dropdownMenu.classList.toggle('show');
            });

            // 点击其他地方关闭下拉菜单
            document.addEventListener('click', function (e) {
                if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });
        }

        // 更新当前分类的文档列表
        function updateCurrentCategoryDocs(filePath) {
            const currentCategoryTitle = document.getElementById('current-category-title');
            const currentCategoryDocs = document.getElementById('current-category-docs');

            if (!currentCategoryTitle || !currentCategoryDocs) return;

            // 等待配置加载完成
            if (!DOC_CONFIG || ALL_DOCS.length === 0) {
                console.warn('文档配置尚未加载，稍后重试');
                setTimeout(() => updateCurrentCategoryDocs(filePath), 100);
                return;
            }

            // 查找当前文档信息
            const currentDoc = ALL_DOCS.find(doc => doc.filename === filePath);
            
            if (!currentDoc) {
                // 如果找不到文档，显示所有文档
                currentCategoryTitle.textContent = '所有文档';
                currentCategoryDocs.innerHTML = '';
                
                ALL_DOCS.forEach(doc => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `?file=${doc.filename}`;
                    link.textContent = doc.title;
                    link.title = `${doc.author} - ${doc.description || doc.title}`;
                    
                    if (doc.filename === filePath) {
                        link.classList.add('active');
                    }
                    
                    li.appendChild(link);
                    currentCategoryDocs.appendChild(li);
                });
                
                return;
            }

            // 显示当前文档的分类信息
            const category = MAIN_CATEGORIES[currentDoc.category];
            const topic = TOPIC_AREAS[currentDoc.topic];
            
            let titleText = category ? category.title : currentDoc.category;
            if (topic) {
                titleText += ` - ${topic.title}`;
            }
            
            currentCategoryTitle.textContent = titleText;

            // 清空现有列表
            currentCategoryDocs.innerHTML = '';

            // 显示同一分类和主题下的其他文档
            const relatedDocs = ALL_DOCS.filter(doc =>
                doc.category === currentDoc.category && doc.topic === currentDoc.topic
            ).sort((a, b) => a.order - b.order);

            if (relatedDocs.length > 0) {
                relatedDocs.forEach(doc => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `?file=${doc.filename}`;
                    link.textContent = doc.title;
                    link.title = `${doc.author} - ${doc.description || doc.title}`;
                    
                    if (doc.filename === filePath) {
                        link.classList.add('active');
                    }
                    
                    li.appendChild(link);
                    currentCategoryDocs.appendChild(li);
                });
            } else {
                // 如果没有相关文档，显示同一分类下的所有文档
                const categoryDocs = ALL_DOCS.filter(doc =>
                    doc.category === currentDoc.category
                ).sort((a, b) => a.order - b.order);
                
                categoryDocs.forEach(doc => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `?file=${doc.filename}`;
                    link.textContent = doc.title;
                    link.title = `${doc.author} - ${doc.description || doc.title}`;
                    
                    if (doc.filename === filePath) {
                        link.classList.add('active');
                    }
                    
                    li.appendChild(link);
                    currentCategoryDocs.appendChild(li);
                });
            }
        }
    </script>
</body>

</html>